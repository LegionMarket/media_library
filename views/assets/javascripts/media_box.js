!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"==typeof exports?require("jquery"):jQuery)}(function(e){"use strict";function t(i,n){this.$element=e(i),this.options=e.extend({},t.DEFAULTS,e.isPlainObject(n)&&n),this.init()}var i=e("body"),n=e(document),a=window.Mustache,o="qor.medialibrary",r="click."+o,s="enable."+o,d="disable."+o,l=".qor-select__select-icon",c=".qor-selectmany__hint",h=".qor-field__mediabox",m=".qor-field__mediabox-list",f=".qor-field__mediabox-item",u=".qor-field__mediabox-data",p=".qor-bottomsheets",_="is_selected",y="is_deleted",g="textarea.qor-file__options",b=".qor-cropper__toggle--delete",S=".qor-cropper__toggle--undo";return t.prototype={constructor:t,init:function(){var e=this.$element;this.SELECT_MEDIABOX_UNDO_TEMPLATE=e.find('[name="media-box-undo-delete"]').html(),this.bind()},bind:function(){n.on(r,"[data-mediabox-url]",this.openBottomSheets.bind(this)),this.$element.on(r,b,this.deleteSelected.bind(this)).on(r,S,this.undoDeleteSelected.bind(this)).on("change.qor.cropper",g,this.imageCrop.bind(this))},deleteSelected:function(t){var i=e(t.target),n=i.closest(f);return n.addClass(y).append(this.SELECT_MEDIABOX_UNDO_TEMPLATE).find(".qor-file__list").hide(),this.updateMediaLibraryData(i.closest(m)),!1},undoDeleteSelected:function(t){var i=e(t.target),n=i.closest(f);return n.removeClass(y).find(".qor-file__list").show(),this.updateMediaLibraryData(i.closest(m)),i.closest(".qor-fieldset__alert").remove(),!1},imageCrop:function(t){var i=e(t.target).closest(f);this.syncImageCrop(i)},openBottomSheets:function(t){var n,a=e(t.target).closest("[data-mediabox-url]"),o=a.data();this.BottomSheets=i.data("qor.bottomsheets"),this.bottomsheetsData=o,this.$parent=n=a.closest(h),this.$selectFeild=n.find(m),o.url=o.mediaboxUrl,this.SELECT_MANY_SELECTED_ICON=e('[name="select-many-selected-icon"]').html(),this.SELECT_MANY_HINT=e('[name="select-many-hint"]').html(),this.SELECT_MEDIABOX_TEMPLATE=n.find('[name="media-box-template"]').html(),this.SELECT_MEDIABOX_UNDO_TEMPLATE=n.find('[name="media-box-undo-delete"]').html(),this.BottomSheets.open(o,this.handleSelectMany.bind(this))},initItems:function(){var t,i,n=this.$selectFeild,a=n.find(f).not("."+y),o=e(p).find("tbody tr"),r=this;a.each(function(){i=e(this).data().primaryKey,t=o.filter('[data-primary-key="'+i+'"]').addClass(_),r.changeIcon(t,!0)}),this.updateHint(this.getSelectedItemData())},renderSelectMany:function(e){return a.render(this.SELECT_MEDIABOX_TEMPLATE,e)},renderHint:function(e){return a.render(this.SELECT_MANY_HINT,e)},getSelectedItemData:function(t){var i,n=t?t:this.$selectFeild,a=n.find(f).not("."+y),o=[];return a.size()&&a.each(function(){i=e(this).data(),o.push({ID:i.primaryKey,Url:i.originalUrl.replace(/.original.(\w+)$/,".$1")})}),{files:o,selectedNum:o.length}},updateHint:function(t){var i;e.extend(t,this.bottomsheetsData),i=this.renderHint(t),e(c).remove(),e(p).find(".qor-bottomsheets__body").prepend(i)},updateMediaLibraryData:function(e){var t=e?e.find(u):this.$selectFeild.find(u),i=this.getSelectedItemData(e);t.val(JSON.stringify(i.files))},changeIcon:function(e,t){var i=e.find(".qor-table--medialibrary-item"),n=i.size()?i:e.find("td:first");e.find(l).remove(),t&&n.prepend(this.SELECT_MANY_SELECTED_ICON)},syncImageCrop:function(t,i){var n=JSON.parse(t.find(g).val()),a=t.data().mediaLibraryUrl,o={};delete n.ID,delete n.Url,o.MediaOption=JSON.stringify(n),e.ajax({type:"PUT",url:a,data:JSON.stringify(o),contentType:"application/json",dataType:"json",success:function(n){o.MediaOption=JSON.parse(n.MediaOption),i&&e.isFunction(i)&&i(o,t)}})},removeItem:function(e){var t=e.primaryKey;this.$selectFeild.find('[data-primary-key="'+t+'"]').remove(),this.changeIcon(e.$clickElement)},addItem:function(t,i){var n=e(this.renderSelectMany(t)),a=n.find(".qor-file__input"),o=a.closest(f),r=this.$selectFeild.find('[data-primary-key="'+t.primaryKey+'"]'),s=this;return r.size()?(r.removeClass(y).find(".qor-file__list").show(),void r.find(".qor-fieldset__alert").remove()):(n.appendTo(this.$selectFeild),t.MediaOption.CropOptions&&this.resetImages(t,n),n.find(g).val(JSON.stringify(t.MediaOption)),n.trigger("enable"),t.MediaOption.CropOptions||a.data("qor.cropper").load(t.MediaOption.URL,function(){s.syncImageCrop(o,s.resetImages)}),i?void this.BottomSheets.hide():void this.changeIcon(t.$clickElement,!0))},resetImages:function(t,i){var n=t.MediaOption.CropOptions,a=Object.keys(n),o=t.MediaOption.OriginalURL;if(/original/.test(o)){for(var r=a.length-1;r>=0;r--)n[a[r]].URL=o.replace(/original/,a[r]);i.find("img").each(function(){var t=e(this),i=t.data().sizeName;i&&"original"!=i&&n[i]&&(console.log(n[i].URL),t.prop("src",n[i].URL))})}},handleSelectMany:function(){var t=e(p),i={formatOnSelect:this.formatSelectResults.bind(this),formatOnSubmit:this.formatSubmitResults.bind(this)};t.qorSelectCore(i),this.initItems()},formatSelectResults:function(e){this.formatResults(e)},formatSubmitResults:function(e){this.formatResults(e,!0)},formatResults:function(t,i){var n=t.url||t.mediaLibraryUrl,a=this,o=t;e.getJSON(n,function(t){t.MediaOption=JSON.parse(t.MediaOption),e.extend(o,t),a.handleFormat(o,i)})},handleFormat:function(e,t){var i,n=e.$clickElement;e.mediaLibraryUrl||(e.mediaLibraryUrl=e.url),n.toggleClass(_),i=n.hasClass(_),i?this.addItem(e):this.removeItem(e),this.updateHint(this.getSelectedItemData()),this.updateMediaLibraryData()}},t.plugin=function(i){return this.each(function(){var n,a=e(this),r=a.data(o);if(!r){if(/destroy/.test(i))return;a.data(o,r=new t(this,i))}"string"==typeof i&&e.isFunction(n=r[i])&&n.apply(r)})},e(function(){var i='[data-toggle="qor.mediabox"]';e(document).on(d,function(n){t.plugin.call(e(i,n.target),"destroy")}).on(s,function(n){t.plugin.call(e(i,n.target))}).triggerHandler(s)}),t});
//# sourceMappingURL=media_box.js.map
