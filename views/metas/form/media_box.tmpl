{{$metaConfig := .Meta.Config}}

<div class="qor-field qor-field__mediabox" data-toggle="qor.mediabox">
  <label class="qor-field__label" for="{{.InputId}}">
    {{meta_label .Meta}}
  </label>

  <div class="qor-field__block">
    {{$value := (raw_value_of .ResourceValue .Meta)}}

    <div class="qor-field__edit">

      <textarea class="hidden qor-field__mediabox-data" name="{{.InputName}}" aria-hidden="true">{{marshal $value.Files}}</textarea>

      <div class="qor-field__mediabox-list">
        <label class="mdl-button mdl-button--fab mdl-button--mini-fab mdl-button--primary mdl-js-button mdl-js-ripple-effect"
               data-mediabox-url="{{url_for $metaConfig.RemoteDataResource}}"
               data-select-modal=true
               data-select-id={{.InputId}}
               title="{{t "qor_media_library.form.choose_file" "Choose File"}}" {{if not (has_update_permission .Meta)}}disabled{{end}}
               {{if $metaConfig.Max}}data-max="{{$metaConfig.Max}}"{{end}}>
            <i class="material-icons">file_upload</i>
        </label>



        {{if $value.Files}}

          {{range $file := $value.Files}}
            <div class="qor-file qor-field__mediabox-item" data-primary-key={{$file.ID}} data-original-url="{{$file.URL "original"}}">
              <div class="qor-file__list">
                <textarea class="qor-file__options hidden" data-cropper-title="{{t "qor_media_library.form.crop_image" "Crop the image"}}" data-cropper-cancel="{{t "qor_media_library.form.cancel" "Cancel"}}" data-cropper-ok="{{t "qor_media_library.form.save" "SAVE"}}" aria-hidden="true">{{marshal $file}}</textarea>
                <ul>
                  {{if $metaConfig.Sizes}}
                    {{range $key, $size := $metaConfig.Sizes}}
                      {{if not (is_included $key "@")}}
                        <li>
                          <img src="{{$file.URL $key}}" data-original-url="{{$file.URL "original"}}" data-size-name="{{$key}}" data-size-resolution="{{marshal $size}}" />
                          <span>{{$key}} ({{$size.Width}}&times;{{$size.Height}} px)</span>
                        </li>
                      {{end}}
                    {{end}}
                  {{else}}
                    <li>
                      <img src="{{$value.URL}}" data-original-url="{{$value.URL "original"}}" data-size-name="original" alt="{{$value.GetFileName}}">
                    </li>
                  {{end}}

                </ul>
                <input type="file" class="qor-file__input visuallyhidden" />
              </div>
            </div>

          {{end}}

        {{end}}
        
      </div>
    </div>
  </div>
</div>

<script name="media-box-template" type="x-tmpl-mustache">
  [[#File]]
    <div class="qor-file qor-field__mediabox-item" data-primary-key=[[primaryKey]] data-original-url=[[File.Url]]>
      <div class="qor-file__list">
        <textarea class="qor-file__options hidden" data-cropper-title="{{t "qor_media_library.form.crop_image" "Crop the image"}}" data-cropper-cancel="{{t "qor_media_library.form.cancel" "Cancel"}}" data-cropper-ok="{{t "qor_media_library.form.save" "SAVE"}}" aria-hidden="true"></textarea>
        <ul>
          <li>
            <img src="[[File.Url]]" alt="[[Title]]" data-original-url="[[File.Url]]" data-size-name="original" />
          </li>
        </ul>
        <span class="qor-file__input visuallyhidden"></span>
      </div>
    </div>
  [[/File]]
</script>

<script name="select-many-selected-icon" type="x-tmpl-mustache">
  <span class="qor-select__select-icon"><i class="material-icons">check_circle</i></span>
</script>

{{javascript_tag "media_box"}}
{{stylesheet_tag "media_box"}}
